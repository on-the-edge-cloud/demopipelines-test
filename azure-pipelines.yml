trigger:
- main

pool:
  name: Linux-MSI-local

jobs:
  - job: Build
    steps:
      - powershell: Invoke-Pester -Output Detailed -ExcludeTagFilter "Integration"
        displayName: Unit tests (Pester)
      - powershell: Invoke-Pester -Output Detailed -TagFilter "Integration"
        displayName: Integration tests (Pester)
      - powershell: |
          $config = New-PesterConfiguration
          $config.CodeCoverage.OutputFormat = 'JaCoCo'
          $config.CodeCoverage.OutputPath = 'cov.xml'
          $config.CodeCoverage.OutputEncoding = 'UTF8'
          $config.CodeCoverage.Path = "src"
          $config.CodeCoverage.Enabled = $true
          Invoke-Pester -Configuration $config
        displayName: Code coverage (Pester)
      - task: PublishCodeCoverageResults@2
        displayName: 'Publish code coverage results'
        inputs:
          summaryFileLocation: '$(System.DefaultWorkingDirectory)/cov.xml'
